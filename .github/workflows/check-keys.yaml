name: Check for Crypto Keys

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

env:
  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

jobs:
  check-keys:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start check
        run: |
          echo "CHECK_START=$(date +%s)" >> $GITHUB_ENV
          echo "PRIVATE_KEYS_FOUND=0" >> $GITHUB_ENV
          echo "PUBLIC_KEYS_FOUND=0" >> $GITHUB_ENV
          echo "FILES_CHECKED=0" >> $GITHUB_ENV

      - name: Check for private keys
        run: |
          echo "üîç Checking for PRIVATE keys..."
          
          # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π
          PRIVATE_KEY_PATTERNS=(
            "-----BEGIN PRIVATE KEY-----"
            "-----BEGIN RSA PRIVATE KEY-----"
            "-----BEGIN EC PRIVATE KEY-----"
            "-----BEGIN OPENSSH PRIVATE KEY-----"
            "-----BEGIN PGP PRIVATE KEY BLOCK-----"
          )
          
          # –ò—â–µ–º —Ñ–∞–π–ª—ã –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º
          for file in $(find . -type f ! -path "./.git/*"); do
            if [ -f "$file" ]; then
              FILES_CHECKED=$((FILES_CHECKED + 1))
              
              for pattern in "${PRIVATE_KEY_PATTERNS[@]}"; do
                if grep -q "$pattern" "$file" 2>/dev/null; then
                  echo "‚ö†Ô∏è  FOUND PRIVATE KEY in: $file"
                  echo "   Pattern: $pattern"
                  PRIVATE_KEYS_FOUND=$((PRIVATE_KEYS_FOUND + 1))
                fi
              done
            fi
          done
          
          echo "PRIVATE_KEYS_FOUND=$PRIVATE_KEYS_FOUND" >> $GITHUB_ENV
          echo "FILES_CHECKED=$FILES_CHECKED" >> $GITHUB_ENV

      - name: Check for public keys
        run: |
          echo "üîç Checking for PUBLIC keys..."
          
          # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π
          PUBLIC_KEY_PATTERNS=(
            "-----BEGIN PUBLIC KEY-----"
            "ssh-rsa AAAAB3"
            "ssh-ed25519 AAAAC3"
            "ssh-dss AAAAB3"
            "-----BEGIN PGP PUBLIC KEY BLOCK-----"
          )
          
          for file in $(find . -type f ! -path "./.git/*"); do
            if [ -f "$file" ]; then
              for pattern in "${PUBLIC_KEY_PATTERNS[@]}"; do
                if grep -q "$pattern" "$file" 2>/dev/null; then
                  echo "üîë FOUND PUBLIC KEY in: $file"
                  echo "   Pattern: $pattern"
                  PUBLIC_KEYS_FOUND=$((PUBLIC_KEYS_FOUND + 1))
                fi
              done
            fi
          done
          
          echo "PUBLIC_KEYS_FOUND=$PUBLIC_KEYS_FOUND" >> $GITHUB_ENV

      - name: Calculate check time
        run: |
          CHECK_END=$(date +%s)
          CHECK_TIME=$((CHECK_END - ${{ env.CHECK_START }}))
          
          if [ $CHECK_TIME -lt 60 ]; then
            TIME_READABLE="${CHECK_TIME} seconds"
          else
            MINUTES=$((CHECK_TIME / 60))
            SECONDS=$((CHECK_TIME % 60))
            TIME_READABLE="${MINUTES}m ${SECONDS}s"
          fi
          echo "TIME_READABLE=$TIME_READABLE" >> $GITHUB_ENV

      - name: Prepare results
        run: |
          TOTAL_KEYS_FOUND=$(( ${{ env.PRIVATE_KEYS_FOUND }} + ${{ env.PUBLIC_KEYS_FOUND }} ))
          
          if [ $TOTAL_KEYS_FOUND -eq 0 ]; then
            TITLE="‚úÖ **No Crypto Keys Found**"
            COLOR="5814783"
            STATUS="üü¢ No keys detected"
          else
            TITLE="‚ö†Ô∏è  **Crypto Keys Found!**"
            COLOR="16753920"
            STATUS="üü† Found $TOTAL_KEYS_FOUND keys"
          fi
          
          echo "TITLE=$TITLE" >> $GITHUB_ENV
          echo "COLOR=$COLOR" >> $GITHUB_ENV
          echo "STATUS=$STATUS" >> $GITHUB_ENV
          echo "TOTAL_KEYS_FOUND=$TOTAL_KEYS_FOUND" >> $GITHUB_ENV

      - name: Send results to Discord
        uses: Ilshidur/action-discord@0.3.2
        with:
          args: |
            ${{ env.TITLE }}
            üì¶ Repository: ${{ github.repository }}
            üîÄ Branch: ${{ github.ref_name }}
            üìù Commit: ${{ github.sha }}
            üìä Files Checked: ${{ env.FILES_CHECKED }}
            üîí Private Keys: ${{ env.PRIVATE_KEYS_FOUND }}
            üîë Public Keys: ${{ env.PUBLIC_KEYS_FOUND }}
            ‚ö†Ô∏è  Total Keys: ${{ env.TOTAL_KEYS_FOUND }}
            ‚è±Ô∏è Time: ${{ env.TIME_READABLE }}
            üìã Status: ${{ env.STATUS }}
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

      - name: Show final results
        run: |
          echo "=== CRYPTO KEYS SCAN RESULTS ==="
          echo "Files Checked: ${{ env.FILES_CHECKED }}"
          echo "Private Keys Found: ${{ env.PRIVATE_KEYS_FOUND }}"
          echo "Public Keys Found: ${{ env.PUBLIC_KEYS_FOUND }}"
          echo "Total Keys Found: ${{ env.TOTAL_KEYS_FOUND }}"
          echo "Scan Time: ${{ env.TIME_READABLE }}"
          echo "Status: ${{ env.STATUS }}"
          echo "================================"
