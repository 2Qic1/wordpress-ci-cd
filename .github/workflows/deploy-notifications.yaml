name: Deployment Notifications

on:
  push:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      deploy_version:
        description: 'Which version to deploy'
        required: true
        type: choice
        options:
          - v1
          - v2
        default: 'v1'

env:
  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

jobs:
  push-notification:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Send push notification
        uses: Ilshidur/action-discord@0.3.2
        with:
          args: |
            ğŸ“Œ **Push to Master**
            ğŸ“¦ Repository: ${{ github.repository }}
            ğŸ”€ Branch: ${{ github.ref_name }}
            ğŸ‘¤ Author: ${{ github.actor }}
            ğŸ“ Commit: ${{ github.sha }}
            ğŸ“‹ Message: ${{ github.event.head_commit.message }}
            ğŸ“ Changed files: ${{ join(github.event.head_commit.modified, ', ') }}
            ğŸŒ URL: ${{ github.event.head_commit.url }}
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

  manual-deployment:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show selected version
        run: |
          echo "Selected version: ${{ github.event.inputs.deploy_version }}"
          echo "DEPLOY_VERSION=${{ github.event.inputs.deploy_version }}" >> $GITHUB_ENV

      - name: Send deployment start notification
        uses: Ilshidur/action-discord@0.3.2
        with:
          args: |
            ğŸš€ **Manual Deployment Started**
            ğŸ“¦ Repository: ${{ github.repository }}
            ğŸ¯ Version: ${{ github.event.inputs.deploy_version }}
            ğŸ‘¤ Initiated by: ${{ github.actor }}
            â° Start time: $(date +"%Y-%m-%d %H:%M:%S")
            ğŸ’¡ Type: Manual deployment with version selection
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

      - name: Start deployment timer
        run: echo "DEPLOY_START=$(date +%s)" >> $GITHUB_ENV

      - name: Deploy to Kubernetes
        run: |
          echo "ğŸš€ Starting Kubernetes deployment for version: ${{ github.event.inputs.deploy_version }}"
          
          # Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ Ğ¸Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° (Ğ¾Ğ±Ñ‰Ğ°Ñ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ²ĞµÑ€ÑĞ¸Ğ¹)
          kubectl apply -f namespace.yaml
          kubectl apply -f mariadb-secret.yaml
          kubectl apply -f mariadb-pvc.yaml
          kubectl apply -f mariadb-deployment.yaml
          kubectl apply -f mariadb-service.yaml
          kubectl apply -f wordpress-pvc.yaml
          
          # Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸ WordPress
          if [ "${{ github.event.inputs.deploy_version }}" == "v2" ]; then
            echo "Deploying WordPress v2..."
            kubectl apply -f wordpress-deployment-v2.yaml
          else
            echo "Deploying WordPress v1..."
            kubectl apply -f wordpress-deployment.yaml
          fi
          
          # ĞĞ±Ñ‰Ğ¸Ğµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹
          kubectl apply -f wordpress-service.yaml
          kubectl apply -f wordpress-ingress.yaml
          
          echo "âœ… All manifests applied successfully"

      - name: Wait for deployment completion
        run: |
          echo "â³ Waiting for WordPress to be ready..."
          kubectl rollout status deployment/wordpress -n wordpress --timeout=300s
          
          echo "â³ Waiting for MariaDB to be ready..."
          kubectl rollout status deployment/mariadb -n wordpress --timeout=300s
          
          echo "âœ… All deployments are ready"

      - name: Calculate deployment time
        run: |
          DEPLOY_END=$(date +%s)
          DEPLOY_TIME=$((DEPLOY_END - ${{ env.DEPLOY_START }}))
          echo "DEPLOYMENT_TIME=$DEPLOY_TIME" >> $GITHUB_ENV
          
          # ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ² Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚
          if [ $DEPLOY_TIME -lt 60 ]; then
            TIME_READABLE="${DEPLOY_TIME} seconds"
          else
            MINUTES=$((DEPLOY_TIME / 60))
            SECONDS=$((DEPLOY_TIME % 60))
            TIME_READABLE="${MINUTES}m ${SECONDS}s"
          fi
          echo "TIME_READABLE=$TIME_READABLE" >> $GITHUB_ENV
          echo "â±ï¸ Deployment completed in: $TIME_READABLE"

      - name: Get deployment status
        id: deployment_status
        run: |
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ´ĞµĞ¿Ğ»Ğ¾Ğµ
          WP_STATUS=$(kubectl get deployment wordpress -n wordpress -o jsonpath='{.status.conditions[?(@.type=="Available")].status}')
          DB_STATUS=$(kubectl get deployment mariadb -n wordpress -o jsonpath='{.status.conditions[?(@.type=="Available")].status}')
          
          echo "WP_STATUS=$WP_STATUS" >> $GITHUB_ENV
          echo "DB_STATUS=$DB_STATUS" >> $GITHUB_ENV
          
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ĞµÑ€ÑĞ¸Ñ Ğ¸Ğ· deployment Ñ„Ğ°Ğ¹Ğ»Ğ°
          if [ "${{ github.event.inputs.deploy_version }}" == "v2" ]; then
            VERSION_INFO=$(grep "version:" wordpress-deployment-v2.yaml | awk '{print $2}' | tr -d '"' || echo "v2")
          else
            VERSION_INFO=$(grep "version:" wordpress-deployment.yaml | awk '{print $2}' | tr -d '"' || echo "v1")
          fi
          echo "VERSION_INFO=$VERSION_INFO" >> $GITHUB_ENV

      - name: Send deployment success notification
        uses: Ilshidur/action-discord@0.3.2
        with:
          args: |
            âœ… **Manual Deployment Successful!**
            ğŸ“¦ Repository: ${{ github.repository }}
            ğŸ¯ Selected Version: ${{ github.event.inputs.deploy_version }}
            ğŸ“‹ Actual Version: ${{ env.VERSION_INFO }}
            â±ï¸ **Deployment Time: ${{ env.TIME_READABLE }}**
            ğŸ‘¤ Deployed by: ${{ github.actor }}
            ğŸ“Š Status: All systems operational
            ğŸŸ¢ WordPress: ${{ env.WP_STATUS }}
            ğŸŸ¢ MariaDB: ${{ env.DB_STATUS }}
            ğŸ‰ Deployment completed successfully!
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

      - name: Send deployment failure notification
        if: failure()
        uses: Ilshidur/action-discord@0.3.2
        with:
          args: |
            âŒ **Manual Deployment Failed!**
            ğŸ“¦ Repository: ${{ github.repository }}
            ğŸ¯ Version: ${{ github.event.inputs.deploy_version }}
            â±ï¸ Elapsed Time: ${{ env.TIME_READABLE }}
            ğŸ‘¤ Deployed by: ${{ github.actor }}
            ğŸ”´ Status: Deployment failed
            âš ï¸ Error: Check GitHub Actions logs for details
            ğŸ’¡ Action required: Please investigate the failure
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
