name: Discord Push Notifications

on:
  push:
    branches: [ master ]

env:
  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Get current timestamp
        id: timestamp
        run: |
          echo "CURRENT_TIME=$(date +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_ENV
          echo "TIMESTAMP_READABLE=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV

      - name: Get commit details
        id: commit_info
        run: |
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹ Ñ…ÑÑˆ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ°
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_OUTPUT
          
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ½Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
          CHANGED_FILES_COUNT=$(git diff --name-only HEAD~1 HEAD | wc -l)
          echo "CHANGED_FILES_COUNT=$CHANGED_FILES_COUNT" >> $GITHUB_OUTPUT
          
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ½Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² (Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 5)
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | head -5 | tr '\n' ', ' | sed 's/, $//')
          echo "CHANGED_FILES=$CHANGED_FILES" >> $GITHUB_OUTPUT
          
          if [ $CHANGED_FILES_COUNT -gt 5 ]; then
            echo "EXTRA_FILES=true" >> $GITHUB_OUTPUT
          else
            echo "EXTRA_FILES=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Discord notification
        uses: Ilshidur/action-discord@0.3.2
        with:
          args: |
            ğŸ“Œ **New Push to Master**
            ğŸ“¦ Repository: ${{ github.repository }}
            ğŸ”€ Branch: ${{ github.ref_name }}
            ğŸ‘¤ Author: ${{ github.actor }}
            ğŸ“ Commit: [${{ steps.commit_info.outputs.SHORT_SHA }}](${{ github.event.head_commit.url }})
            ğŸ“‹ Message: ${{ github.event.head_commit.message }}
            ğŸ“ Changed files: ${{ steps.commit_info.outputs.CHANGED_FILES_COUNT }}
            ğŸ“„ Files: ${{ steps.commit_info.outputs.CHANGED_FILES }}${{ steps.commit_info.outputs.EXTRA_FILES == 'true' && '...' || '' }}
            ğŸ•’ Time: ${{ env.TIMESTAMP_READABLE }}
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
