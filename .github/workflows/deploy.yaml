name: Deploy WordPress

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Test Kustomize build
      run: |
        kubectl kustomize . --enable-helm

    - name: Validate YAML
      uses: actions/github-script@v6
      with:
        script: |
          const yaml = require('js-yaml');
          const fs = require('fs');
          
          function validateYaml(filePath) {
            try {
              const content = fs.readFileSync(filePath, 'utf8');
              yaml.load(content);
              console.log(`‚úì ${filePath} is valid YAML`);
            } catch (e) {
              throw new Error(`‚ùå ${filePath} has YAML error: ${e.message}`);
            }
          }
          
          // Validate all YAML files
          const files = [
            'base/namespace.yaml',
            'base/secret.yaml',
            'apps/mysql/deployment.yaml',
            'apps/mysql/service.yaml',
            'apps/mysql/pvc.yaml',
            'apps/wordpress/deployment.yaml',
            'apps/wordpress/service.yaml',
            'apps/wordpress/ingress.yaml',
            'apps/wordpress/pvc.yaml',
            'monitoring/servicemonitor.yaml',
            'monitoring/prometheus-rules.yaml'
          ];
          
          files.forEach(validateYaml);

  deploy-notification:
    needs: test-deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Send Discord notification
      uses: Ilshidur/action-discord@0.3.1
      with:
        args: 'üöÄ Deployment started: WordPress to production'
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
