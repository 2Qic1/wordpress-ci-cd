name: Validate Kubernetes Manifests

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

env:
  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

jobs:
  validate-manifests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        id: setup
        run: |
          echo "VALIDATION_START=$(date +%s)" >> $GITHUB_ENV
          echo "REPO_URL=https://github.com/${{ github.repository }}" >> $GITHUB_ENV
          echo "BRANCH=${{ github.ref_name }}" >> $GITHUB_ENV
          echo "ERROR_COUNT=0" >> $GITHUB_ENV
          echo "KUBE_ERRORS=0" >> $GITHUB_ENV
          echo "MISSING_KEYS=0" >> $GITHUB_ENV

      - name: Install tools
        run: |
          pip install yamllint
          wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      - name: Validate YAML syntax
        id: yaml_validation
        run: |
          echo "üîç Validating YAML syntax..."
          ERROR_COUNT=0
        
          for file in $(find . -name "*.yaml" -o -name "*.yml"); do
            echo "Checking $file"
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º || true —á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
            if ! yamllint "$file" --no-warnings; then
              echo "‚ùå YAML error in $file"
              ((ERROR_COUNT++))
            fi
          done
        
          echo "ERROR_COUNT=$ERROR_COUNT" >> $GITHUB_ENV
          echo "YAML_FILES_CHECKED=$(find . -name "*.yaml" -o -name "*.yml" | wc -l)" >> $GITHUB_ENV

      - name: Validate Kubernetes manifests
        id: kube_validation
        run: |
          echo "üîç Validating Kubernetes manifests..."
          KUBE_ERRORS=0
          MANIFEST_FILES=0
        
          for file in $(find . -name "*.yaml" -o -name "*.yml"); do
            if grep -q "apiVersion:" "$file" && grep -q "kind:" "$file"; then
              echo "Validating Kubernetes manifest: $file"
              ((MANIFEST_FILES++))
            
              # –ò—Å–ø–æ–ª—å–∑—É–µ–º || true —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
              if ! kubeval "$file" --strict --ignore-missing-schemas; then
                echo "‚ùå Kubernetes validation failed for $file"
                ((KUBE_ERRORS++))
              fi
            fi
          done
        
          echo "KUBE_ERRORS=$KUBE_ERRORS" >> $GITHUB_ENV
          echo "MANIFEST_FILES=$MANIFEST_FILES" >> $GITHUB_ENV

      - name: Check for required keys
        id: key_check
        run: |
          echo "üîë Checking for required keys..."
          MISSING_KEYS=0
        
          for file in $(find . -name "*deployment*.yaml" -o -name "*deployment*.yml"); do
            echo "Checking required keys in: $file"
            
            REQUIRED_FIELDS=("apiVersion" "kind" "metadata.name" "spec.template.spec.containers")
            for field in "${REQUIRED_FIELDS[@]}"; do
              if ! yq eval ".$field" "$file" > /dev/null 2>&1; then
                echo "‚ùå Missing required field: $field in $file"
                ((MISSING_KEYS++))
              fi
            done
          done
        
          echo "MISSING_KEYS=$MISSING_KEYS" >> $GITHUB_ENV

      - name: Calculate validation time
        run: |
          VALIDATION_END=$(date +%s)
          VALIDATION_TIME=$((VALIDATION_END - ${{ env.VALIDATION_START }}))
          echo "VALIDATION_TIME=$VALIDATION_TIME" >> $GITHUB_ENV
        
          if [ $VALIDATION_TIME -lt 60 ]; then
            TIME_READABLE="${VALIDATION_TIME} seconds"
          else
            MINUTES=$((VALIDATION_TIME / 60))
            SECONDS=$((VALIDATION_TIME % 60))
            TIME_READABLE="${MINUTES}m ${SECONDS}s"
          fi
          echo "TIME_READABLE=$TIME_READABLE" >> $GITHUB_ENV

      - name: Prepare validation results
        id: validation_results
        run: |
          TOTAL_ERRORS=$(( ${{ env.ERROR_COUNT }} + ${{ env.KUBE_ERRORS }} + ${{ env.MISSING_KEYS }} ))
        
          if [ $TOTAL_ERRORS -eq 0 ]; then
            TITLE="‚úÖ **Validation Successful!**"
            COLOR="5814783"
            STATUS="üü¢ All checks passed"
          else
            TITLE="‚ùå **Validation Failed!**"
            COLOR="16711680"
            STATUS="üî¥ Validation failed"
          fi
        
          echo "TITLE=$TITLE" >> $GITHUB_ENV
          echo "COLOR=$COLOR" >> $GITHUB_ENV
          echo "STATUS=$STATUS" >> $GITHUB_ENV
          echo "TOTAL_ERRORS=$TOTAL_ERRORS" >> $GITHUB_ENV

      - name: Send validation results to Discord
        uses: Ilshidur/action-discord@0.3.2
        with:
          args: |
            {
              "content": "${{ env.TITLE }}",
              "embeds": [
                {
                  "title": "Kubernetes Manifest Validation",
                  "color": ${{ env.COLOR }},
                  "fields": [
                    {"name": "Repository", "value": "${{ github.repository }}", "inline": true},
                    {"name": "Branch", "value": "${{ env.BRANCH }}", "inline": true},
                    {"name": "Commit", "value": "${{ github.sha }}", "inline": true},
                    {"name": "YAML Files Checked", "value": "${{ env.YAML_FILES_CHECKED }}", "inline": true},
                    {"name": "K8s Manifests Checked", "value": "${{ env.MANIFEST_FILES }}", "inline": true},
                    {"name": "YAML Syntax Errors", "value": "${{ env.ERROR_COUNT }}", "inline": true},
                    {"name": "K8s Validation Errors", "value": "${{ env.KUBE_ERRORS }}", "inline": true},
                    {"name": "Missing Required Keys", "value": "${{ env.MISSING_KEYS }}", "inline": true},
                    {"name": "Validation Time", "value": "${{ env.TIME_READABLE }}", "inline": true},
                    {"name": "Status", "value": "${{ env.STATUS }}", "inline": true}
                  ]
                }
              ]
            }
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

      - name: Final status
        run: |
          if [ ${{ env.TOTAL_ERRORS }} -ne 0 ]; then
            echo "‚ùå Validation completed with ${{ env.TOTAL_ERRORS }} errors"
            echo "YAML errors: ${{ env.ERROR_COUNT }}"
            echo "Kubernetes errors: ${{ env.KUBE_ERRORS }}"
            echo "Missing keys: ${{ env.MISSING_KEYS }}"
          else
            echo "‚úÖ Validation successful - all checks passed!"
          fi
