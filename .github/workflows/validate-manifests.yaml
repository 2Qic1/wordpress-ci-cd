name: Validate Kubernetes Manifests

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

env:
  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

jobs:
  validate-manifests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          echo "VALIDATION_START=$(date +%s)" >> $GITHUB_ENV
          echo "ERROR_COUNT=0" >> $GITHUB_ENV
          echo "KUBE_ERRORS=0" >> $GITHUB_ENV
          echo "MISSING_KEYS=0" >> $GITHUB_ENV

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install yamllint
          wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      - name: Validate YAML syntax
        run: |
          echo "üîç Validating YAML syntax..."
          ERROR_COUNT=0
          YAML_FILES=0
          
          for file in $(find . -name "*.yaml" -o -name "*.yml"); do
            echo "Checking $file"
            ((YAML_FILES++))
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–≤–æ–¥ –æ—à–∏–±–æ–∫ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –≤—ã–∑–æ–≤–∞
            LINT_OUTPUT=$(yamllint "$file" 2>&1 || true)
            if echo "$LINT_OUTPUT" | grep -q "error"; then
              echo "‚ùå YAML error in $file"
              echo "$LINT_OUTPUT"
              ((ERROR_COUNT++))
            fi
          done
          
          echo "ERROR_COUNT=$ERROR_COUNT" >> $GITHUB_ENV
          echo "YAML_FILES_CHECKED=$YAML_FILES" >> $GITHUB_ENV

      - name: Validate Kubernetes manifests
        run: |
          echo "üîç Validating Kubernetes manifests..."
          KUBE_ERRORS=0
          MANIFEST_FILES=0
          
          for file in $(find . -name "*.yaml" -o -name "*.yml"); do
            if grep -q "apiVersion:" "$file" && grep -q "kind:" "$file"; then
              echo "Validating Kubernetes manifest: $file"
              ((MANIFEST_FILES++))
              # –ò—Å–ø–æ–ª—å–∑—É–µ–º || true —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
              KUBE_OUTPUT=$(kubeval "$file" --strict --ignore-missing-schemas 2>&1 || true)
              if echo "$KUBE_OUTPUT" | grep -q "error"; then
                echo "‚ùå Kubernetes validation failed for $file"
                echo "$KUBE_OUTPUT"
                ((KUBE_ERRORS++))
              fi
            fi
          done
          
          echo "KUBE_ERRORS=$KUBE_ERRORS" >> $GITHUB_ENV
          echo "MANIFEST_FILES=$MANIFEST_FILES" >> $GITHUB_ENV

      - name: Check for required keys
        run: |
          echo "üîë Checking for required keys..."
          MISSING_KEYS=0
          
          for file in $(find . -name "*deployment*.yaml" -o -name "*deployment*.yml"); do
            echo "Checking required keys in: $file"
            
            REQUIRED_FIELDS=("apiVersion" "kind" "metadata.name" "spec.template.spec.containers")
            for field in "${REQUIRED_FIELDS[@]}"; do
              if ! yq eval ".$field" "$file" > /dev/null 2>&1; then
                echo "‚ùå Missing required field: $field in $file"
                ((MISSING_KEYS++))
              fi
            done
          done
          
          echo "MISSING_KEYS=$MISSING_KEYS" >> $GITHUB_ENV

      - name: Calculate validation time
        run: |
          VALIDATION_END=$(date +%s)
          VALIDATION_TIME=$((VALIDATION_END - ${{ env.VALIDATION_START }}))
          echo "VALIDATION_TIME=$VALIDATION_TIME" >> $GITHUB_ENV
          
          if [ $VALIDATION_TIME -lt 60 ]; then
            TIME_READABLE="${VALIDATION_TIME} seconds"
          else
            MINUTES=$((VALIDATION_TIME / 60))
            SECONDS=$((VALIDATION_TIME % 60))
            TIME_READABLE="${MINUTES}m ${SECONDS}s"
          fi
          echo "TIME_READABLE=$TIME_READABLE" >> $GITHUB_ENV

      - name: Prepare validation results
        run: |
          TOTAL_ERRORS=$(( ${{ env.ERROR_COUNT }} + ${{ env.KUBE_ERRORS }} + ${{ env.MISSING_KEYS }} ))
          
          if [ $TOTAL_ERRORS -eq 0 ]; then
            TITLE="‚úÖ **Validation Successful!**"
            COLOR="5814783"
            STATUS="üü¢ All checks passed"
          else
            TITLE="‚ùå **Validation Failed!**"
            COLOR="16711680"
            STATUS="üî¥ Validation failed"
          fi
          
          echo "TITLE=$TITLE" >> $GITHUB_ENV
          echo "COLOR=$COLOR" >> $GITHUB_ENV
          echo "STATUS=$STATUS" >> $GITHUB_ENV
          echo "TOTAL_ERRORS=$TOTAL_ERRORS" >> $GITHUB_ENV

      - name: Send validation results to Discord
        uses: Ilshidur/action-discord@0.3.2
        with:
          args: |
            ${{ env.TITLE }}
            üì¶ Repository: ${{ github.repository }}
            üîÄ Branch: ${{ github.ref_name }}
            üìù Commit: ${{ github.sha }}
            üìä YAML Files: ${{ env.YAML_FILES_CHECKED }}
            üöÄ K8s Manifests: ${{ env.MANIFEST_FILES }}
            ‚ùå YAML Errors: ${{ env.ERROR_COUNT }}
            ‚ùå K8s Errors: ${{ env.KUBE_ERRORS }}
            üîë Missing Keys: ${{ env.MISSING_KEYS }}
            ‚è±Ô∏è Time: ${{ env.TIME_READABLE }}
            üìã Status: ${{ env.STATUS }}
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

      - name: Show final results
        run: |
          echo "=== VALIDATION RESULTS ==="
          echo "YAML Files Checked: ${{ env.YAML_FILES_CHECKED }}"
          echo "YAML Errors: ${{ env.ERROR_COUNT }}"
          echo "K8s Manifests Checked: ${{ env.MANIFEST_FILES }}"
          echo "K8s Errors: ${{ env.KUBE_ERRORS }}"
          echo "Missing Keys: ${{ env.MISSING_KEYS }}"
          echo "Total Errors: ${{ env.TOTAL_ERRORS }}"
          echo "Validation Time: ${{ env.TIME_READABLE }}"
          echo "=========================="
